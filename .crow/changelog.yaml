clone:
  git:
    image: codeberg.org/crow-plugins/clone:1.0.1
    settings:
      tags: true

when:
  event: [push, manual]
  branch: ${CI_REPO_DEFAULT_BRANCH}

steps:
  - name: 'Upcoming Changelog'
    environment:
      ISSUE_TOKEN:
        from_secret: codefloe_issue_rw_token_devxy_bot
    image: docker.io/thegeeklab/git-sv:2.0.4
    commands: |
      apk add -q --no-cache curl jq sed
      git sv rn -o changelog.md
      export RELEASE_NOTES=$(cat changelog.md)
      export ISSUE_NUMBER=$(curl -s "${CI_FORGE_URL}/api/v1/repos/${CI_REPO}/issues?state=open&q=Changelog%20for%20upcoming%20version" | jq '.[].number')

      echo $RELEASE_NOTES

      JSON_DATA=$(echo "" | jq -Rs --arg title 'Changelog for upcoming version' --arg body "$(cat changelog.md)" '{title: $title, body: $body}')

      if [ -z "$ISSUE_NUMBER" ]; then
        curl -s -X POST "${CI_FORGE_URL}/api/v1/repos/${CI_REPO}/issues" -H "Authorization: token $ISSUE_TOKEN" -H "Content-Type: application/json" -d "$JSON_DATA"
      else
        curl -s -X PATCH "${CI_FORGE_URL}/api/v1/repos/${CI_REPO}/issues/$ISSUE_NUMBER" -H "Authorization: token $ISSUE_TOKEN" -H "Content-Type: application/json" -d "$JSON_DATA"
      fi
