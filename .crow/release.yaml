when:
  - event: tag

variables:
  - &golang_image 'docker.io/golang:1.24-alpine'

clone:
  git:
    image: codeberg.org/crow-plugins/clone:1.0.1
    settings:
      tags: true

steps:
  vendor:
    image: *golang_image
    commands:
      - apk add --no-cache -q just
      - just vendor

  build-binaries:
    image: *golang_image
    commands:
      - apk add --no-cache -q just git
      - just build-all

  changelog:
    image: docker.io/thegeeklab/git-sv:2.0.4
    commands:
      - apk add --no-cache -q sed
      - git sv current-version
      - git sv release-notes -t ${CI_COMMIT_TAG} -o CHANGELOG.md
      - sed -i '1,2d' CHANGELOG.md #  remove version
      - cat CHANGELOG.md

  'create release':
    image: docker.io/woodpeckerci/plugin-release:0.2.5
    settings:
      note: CHANGELOG.md
      api_key:
        from_secret: devxy_bot_token
      files:
        - dist/*
      title: ${CI_COMMIT_TAG}
